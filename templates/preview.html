{% extends "base.html" %}
{% block title %}PaySlip Agent - בדיקת נתונים{% endblock %}

{% block extra_head %}
<style>
    .payslip-card {
        display: flex;
        gap: 1.5rem;
        padding: 1.25rem;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        margin-bottom: 1rem;
        transition: all 0.2s;
        align-items: flex-start;
    }
    .payslip-card:hover { border-color: #93c5fd; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .payslip-card.invalid { border-color: #fca5a5; background: #fef2f2; }
    .payslip-card.already-sent { border-color: #fcd34d; background: #fffbeb; }
    .preview-thumb {
        flex-shrink: 0;
        width: 140px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .preview-thumb:hover { transform: scale(1.03); }
    .preview-thumb img { width: 100%; display: block; }
    .payslip-fields {
        flex: 1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }
    .field-group { display: flex; flex-direction: column; gap: 0.2rem; }
    .field-group label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #6b7280;
    }
    .field-group.full-width { grid-column: 1 / -1; }
    .page-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
        grid-column: 1 / -1;
    }
    .page-badge {
        background: #e5e7eb;
        padding: 0.2rem 0.7rem;
        border-radius: 9999px;
        font-size: 0.8rem;
        font-weight: 700;
    }
    .extraction-badge {
        font-size: 0.75rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        background: #dbeafe;
        color: #1e40af;
    }
    .summary {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        align-items: center;
    }
    .summary-item { text-align: center; }
    .summary-item .num { font-size: 2rem; font-weight: 700; color: #0f3460; }
    .summary-item .label { font-size: 0.85rem; color: #6b7280; }
    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
    }
    .input-sm {
        padding: 0.4rem 0.6rem !important;
        font-size: 0.85rem !important;
    }
    .autofill-hint {
        font-size: 0.7rem;
        color: #059669;
        font-weight: 600;
        display: none;
        margin-top: 0.15rem;
    }
    .autofill-hint.visible { display: block; }

    /* Lightbox with zoom */
    .lightbox {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        z-index: 1000;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .lightbox.active { display: flex; }
    .lightbox-controls {
        position: absolute;
        top: 1rem;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 0.5rem;
        z-index: 1001;
    }
    .lightbox-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: rgba(255,255,255,0.2);
        color: white;
        font-size: 1.3rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        font-weight: 700;
        line-height: 1;
    }
    .lightbox-btn:hover { background: rgba(255,255,255,0.4); }
    .lightbox-zoom-level {
        color: rgba(255,255,255,0.7);
        font-size: 0.85rem;
        align-self: center;
        min-width: 45px;
        text-align: center;
    }
    .lightbox-img-wrapper {
        overflow: auto;
        max-width: 95vw;
        max-height: 90vh;
        cursor: grab;
        border-radius: 8px;
    }
    .lightbox-img-wrapper:active { cursor: grabbing; }
    .lightbox-img-wrapper img {
        display: block;
        transform-origin: center center;
        transition: transform 0.15s ease;
        border-radius: 8px;
        box-shadow: 0 4px 30px rgba(0,0,0,0.3);
    }

    /* Confirmation modal */
    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal-box {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        max-width: 450px;
        width: 90%;
        direction: rtl;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    .modal-box h3 { margin-bottom: 1rem; font-size: 1.1rem; }
    .modal-box p { margin-bottom: 0.5rem; font-size: 0.9rem; color: #374151; }
    .modal-box .field-change {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        margin: 0.75rem 0;
        font-size: 0.85rem;
    }
    .modal-box .field-change strong { color: #059669; }
    .modal-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-start;
        margin-top: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="summary">
        <div class="summary-item">
            <div class="num">{{ payslips|length }}</div>
            <div class="label">תלושים נמצאו</div>
        </div>
        <div class="summary-item">
            <div class="num status-ok">{{ payslips|selectattr('is_valid')|list|length }}</div>
            <div class="label">תקינים</div>
        </div>
        <div class="summary-item">
            <div class="num status-err">{{ payslips|rejectattr('is_valid')|list|length }}</div>
            <div class="label">דורשים תיקון</div>
        </div>
        <div class="extraction-badge">
            חילוץ באמצעות: <strong>{{ extraction_method }}</strong>
        </div>
    </div>
</div>

<div class="card">
    <h3 style="margin-bottom: 1rem;">בדוק ותקן את הנתונים לפני שליחה</h3>

    <form action="{{ url_for('process') }}" method="post" id="processForm">
        <input type="hidden" name="session_id" value="{{ session_id }}">

        {% for ps in payslips %}
        <div class="payslip-card {{ '' if ps.is_valid else 'invalid' }} {{ 'already-sent' if ps.already_sent }}" data-idx="{{ loop.index0 }}">
            <div class="preview-thumb" onclick="openLightbox('{{ url_for('page_preview', session_id=session_id, page_number=ps.page - 1) }}')">
                <img src="{{ url_for('page_preview', session_id=session_id, page_number=ps.page - 1) }}"
                     alt="תלוש עמוד {{ ps.page }}" loading="lazy">
            </div>

            <div class="payslip-fields">
                <div class="page-header">
                    <span class="page-badge">עמוד {{ ps.page }}</span>
                    {% if ps.already_sent %}
                    <span class="badge badge-yellow">כבר נשלח בעבר</span>
                    {% endif %}
                    {% if not ps.is_valid %}
                    <span class="badge badge-red">דורש תיקון</span>
                    {% endif %}
                </div>

                <div class="field-group">
                    <label>שם עובד/ת</label>
                    <input type="text" name="name_{{ loop.index0 }}" value="{{ ps.name }}"
                           class="input-sm lookup-field" data-field="name" data-idx="{{ loop.index0 }}"
                           placeholder="שם מלא" required>
                    <div class="autofill-hint" id="hint_name_{{ loop.index0 }}"></div>
                </div>

                <div class="field-group">
                    <label>ת.ז</label>
                    <input type="text" name="employee_id_{{ loop.index0 }}" value="{{ ps.employee_id }}"
                           class="input-sm lookup-field" data-field="employee_id" data-idx="{{ loop.index0 }}"
                           placeholder="מספר ת.ז" required
                           pattern="\d{5,9}" title="5-9 ספרות">
                    <div class="autofill-hint" id="hint_id_{{ loop.index0 }}"></div>
                </div>

                <div class="field-group">
                    <label>אימייל</label>
                    <input type="email" name="email_{{ loop.index0 }}" value="{{ ps.email }}"
                           class="input-sm lookup-field" data-field="email" data-idx="{{ loop.index0 }}"
                           placeholder="email@example.com">
                    <div class="autofill-hint" id="hint_email_{{ loop.index0 }}"></div>
                </div>

                <div class="field-group" style="display: flex; flex-direction: row; gap: 0.5rem; align-items: end;">
                    <div style="flex: 1;">
                        <label>חודש</label>
                        <select name="month_{{ loop.index0 }}" class="input-sm">
                            <option value="">--</option>
                            {% for num, name in hebrew_months.items() %}
                            <option value="{{ num }}" {{ 'selected' if ps.month == num }}>{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label>שנה</label>
                        <input type="number" name="year_{{ loop.index0 }}" value="{{ ps.year }}"
                               class="input-sm" placeholder="שנה" min="1900" max="2100">
                    </div>
                </div>

                <div class="field-group full-width">
                    <label>שם קובץ (מתעדכן אוטומטית)</label>
                    <div class="filename-preview" id="fn_{{ loop.index0 }}"
                         style="font-size: 0.85rem; color: #0f3460; font-weight: 600; padding: 0.3rem 0; direction: rtl;">
                        {{ ps.filename }}.pdf
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <div class="form-actions">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">חזרה</a>
            <button type="submit" class="btn btn-success" id="processBtn">
                הצפן ושלח תלושים
            </button>
        </div>
    </form>
</div>

<!-- Zoomable Lightbox -->
<div class="lightbox" id="lightbox">
    <div class="lightbox-controls">
        <button class="lightbox-btn" onclick="zoomIn()" title="הגדל">+</button>
        <div class="lightbox-zoom-level" id="zoomLevel">100%</div>
        <button class="lightbox-btn" onclick="zoomOut()" title="הקטן">−</button>
        <button class="lightbox-btn" onclick="zoomReset()" title="אפס">⊡</button>
        <button class="lightbox-btn" onclick="closeLightbox()" title="סגור">✕</button>
    </div>
    <div class="lightbox-img-wrapper" id="imgWrapper">
        <img id="lightboxImg" src="" alt="תצוגה מקדימה">
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal-overlay" id="confirmModal">
    <div class="modal-box">
        <h3>נמצא עובד/ת במאגר</h3>
        <p>האם למלא את השדות מהנתונים השמורים?</p>
        <div class="field-change" id="modalDetails"></div>
        <div class="modal-actions">
            <button class="btn btn-success btn-sm" id="modalConfirm">כן, מלא אוטומטית</button>
            <button class="btn btn-secondary btn-sm" id="modalDeny">לא, השאר כמו שזה</button>
        </div>
    </div>
</div>

<script>
    // ===== Hebrew month names =====
    const HEBREW_MONTHS = {
        1: 'ינואר', 2: 'פברואר', 3: 'מרץ', 4: 'אפריל',
        5: 'מאי', 6: 'יוני', 7: 'יולי', 8: 'אוגוסט',
        9: 'ספטמבר', 10: 'אוקטובר', 11: 'נובמבר', 12: 'דצמבר'
    };

    // ===== Live filename update =====
    function updateFilename(idx) {
        const name = document.querySelector(`[name="name_${idx}"]`).value.trim();
        const monthVal = document.querySelector(`[name="month_${idx}"]`).value;
        const yearVal = document.querySelector(`[name="year_${idx}"]`).value.trim();
        const fnEl = document.getElementById(`fn_${idx}`);

        let displayName = name || `employee_page_${idx + 1}`;
        let filename = displayName;

        if (monthVal && yearVal) {
            const hebrewMonth = HEBREW_MONTHS[parseInt(monthVal)] || monthVal;
            filename = `${displayName} - ${hebrewMonth} ${yearVal}`;
        } else if (yearVal) {
            filename = `${displayName} - ${yearVal}`;
        }

        fnEl.textContent = filename + '.pdf';
    }

    const totalPayslips = {{ payslips|length }};
    for (let i = 0; i < totalPayslips; i++) {
        ['name', 'month', 'year'].forEach(field => {
            const el = document.querySelector(`[name="${field}_${i}"]`);
            if (el) {
                el.addEventListener('input', () => updateFilename(i));
                el.addEventListener('change', () => updateFilename(i));
            }
        });
    }

    // ===== Auto-fill from DB with confirmation =====
    let lookupTimeout = {};
    let pendingAutofill = null; // {idx, data, changedField}

    function showConfirmModal(idx, dbData, changedField) {
        const nameEl = document.querySelector(`[name="name_${idx}"]`);
        const idEl = document.querySelector(`[name="employee_id_${idx}"]`);
        const emailEl = document.querySelector(`[name="email_${idx}"]`);

        // Build description of what will be filled
        let changes = [];
        if (changedField !== 'name' && dbData.name && nameEl.value.trim() !== dbData.name) {
            changes.push(`<strong>שם:</strong> ${dbData.name}`);
        }
        if (changedField !== 'employee_id' && dbData.employee_id && idEl.value.trim() !== dbData.employee_id) {
            changes.push(`<strong>ת.ז:</strong> ${dbData.employee_id}`);
        }
        if (changedField !== 'email' && dbData.email && emailEl.value.trim() !== dbData.email) {
            changes.push(`<strong>אימייל:</strong> ${dbData.email}`);
        }

        if (changes.length === 0) return; // Nothing new to fill

        pendingAutofill = { idx, data: dbData, changedField };
        document.getElementById('modalDetails').innerHTML = changes.join('<br>');
        document.getElementById('confirmModal').classList.add('active');
    }

    document.getElementById('modalConfirm').addEventListener('click', () => {
        if (pendingAutofill) {
            const { idx, data, changedField } = pendingAutofill;
            const nameEl = document.querySelector(`[name="name_${idx}"]`);
            const idEl = document.querySelector(`[name="employee_id_${idx}"]`);
            const emailEl = document.querySelector(`[name="email_${idx}"]`);

            if (changedField !== 'name' && data.name) nameEl.value = data.name;
            if (changedField !== 'employee_id' && data.employee_id) idEl.value = data.employee_id;
            if (changedField !== 'email' && data.email) emailEl.value = data.email;

            updateFilename(idx);
        }
        pendingAutofill = null;
        document.getElementById('confirmModal').classList.remove('active');
    });

    document.getElementById('modalDeny').addEventListener('click', () => {
        pendingAutofill = null;
        document.getElementById('confirmModal').classList.remove('active');
    });

    // Debounced lookup on field change
    document.querySelectorAll('.lookup-field').forEach(input => {
        input.addEventListener('change', function() {
            const field = this.dataset.field;
            const idx = parseInt(this.dataset.idx);
            const value = this.value.trim();

            if (!value) return;

            // Debounce
            clearTimeout(lookupTimeout[`${field}_${idx}`]);
            lookupTimeout[`${field}_${idx}`] = setTimeout(() => {
                fetch('/api/employee_lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ field, value })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.found) {
                        showConfirmModal(idx, data, field);
                    }
                })
                .catch(() => {}); // Silently ignore lookup failures
            }, 300);
        });
    });

    // ===== Zoomable Lightbox =====
    let currentZoom = 1;
    const ZOOM_STEP = 0.25;
    const ZOOM_MIN = 0.5;
    const ZOOM_MAX = 4;

    function openLightbox(src) {
        currentZoom = 1;
        updateZoom();
        document.getElementById('lightboxImg').src = src;
        document.getElementById('lightbox').classList.add('active');
    }

    function closeLightbox() {
        document.getElementById('lightbox').classList.remove('active');
    }

    function zoomIn() {
        currentZoom = Math.min(ZOOM_MAX, currentZoom + ZOOM_STEP);
        updateZoom();
    }

    function zoomOut() {
        currentZoom = Math.max(ZOOM_MIN, currentZoom - ZOOM_STEP);
        updateZoom();
    }

    function zoomReset() {
        currentZoom = 1;
        updateZoom();
    }

    function updateZoom() {
        const img = document.getElementById('lightboxImg');
        img.style.transform = `scale(${currentZoom})`;
        document.getElementById('zoomLevel').textContent = `${Math.round(currentZoom * 100)}%`;
    }

    // Scroll wheel zoom
    document.getElementById('imgWrapper').addEventListener('wheel', (e) => {
        e.preventDefault();
        if (e.deltaY < 0) zoomIn();
        else zoomOut();
    });

    // Click on backdrop (not image) to close
    document.getElementById('lightbox').addEventListener('click', (e) => {
        if (e.target === document.getElementById('lightbox')) closeLightbox();
    });

    // Keyboard: Escape to close, +/- to zoom
    document.addEventListener('keydown', (e) => {
        const lb = document.getElementById('lightbox');
        if (!lb.classList.contains('active')) return;
        if (e.key === 'Escape') closeLightbox();
        else if (e.key === '+' || e.key === '=') zoomIn();
        else if (e.key === '-') zoomOut();
        else if (e.key === '0') zoomReset();
    });

    // ===== Submit lock =====
    document.getElementById('processForm').addEventListener('submit', function() {
        const btn = document.getElementById('processBtn');
        btn.disabled = true;
        btn.textContent = 'מעבד ושולח...';
    });
</script>
{% endblock %}
