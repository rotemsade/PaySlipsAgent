{% extends "base.html" %}
{% block title %}PaySlip Agent - בדיקת נתונים{% endblock %}

{% block extra_head %}
<style>
    .payslip-card {
        display: flex;
        gap: 1.5rem;
        padding: 1.25rem;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        margin-bottom: 1rem;
        transition: all 0.2s;
        align-items: flex-start;
    }
    .payslip-card:hover { border-color: #93c5fd; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .payslip-card.invalid { border-color: #fca5a5; background: #fef2f2; }
    .payslip-card.already-sent { border-color: #fcd34d; background: #fffbeb; }
    .preview-thumb {
        flex-shrink: 0;
        width: 140px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .preview-thumb:hover { transform: scale(1.03); }
    .preview-thumb img { width: 100%; display: block; }
    .payslip-fields {
        flex: 1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }
    .field-group { display: flex; flex-direction: column; gap: 0.2rem; }
    .field-group label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #6b7280;
    }
    .field-group.full-width { grid-column: 1 / -1; }
    .page-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
        grid-column: 1 / -1;
    }
    .page-badge {
        background: #e5e7eb;
        padding: 0.2rem 0.7rem;
        border-radius: 9999px;
        font-size: 0.8rem;
        font-weight: 700;
    }
    .extraction-badge {
        font-size: 0.75rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        background: #dbeafe;
        color: #1e40af;
    }
    .summary {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        align-items: center;
    }
    .summary-item { text-align: center; }
    .summary-item .num { font-size: 2rem; font-weight: 700; color: #0f3460; }
    .summary-item .label { font-size: 0.85rem; color: #6b7280; }
    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
    }
    .input-sm {
        padding: 0.4rem 0.6rem !important;
        font-size: 0.85rem !important;
    }
    /* Lightbox */
    .lightbox {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }
    .lightbox.active { display: flex; }
    .lightbox img {
        max-width: 90vw;
        max-height: 90vh;
        border-radius: 8px;
        box-shadow: 0 4px 30px rgba(0,0,0,0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="summary">
        <div class="summary-item">
            <div class="num">{{ payslips|length }}</div>
            <div class="label">תלושים נמצאו</div>
        </div>
        <div class="summary-item">
            <div class="num status-ok">{{ payslips|selectattr('is_valid')|list|length }}</div>
            <div class="label">תקינים</div>
        </div>
        <div class="summary-item">
            <div class="num status-err">{{ payslips|rejectattr('is_valid')|list|length }}</div>
            <div class="label">דורשים תיקון</div>
        </div>
        <div class="extraction-badge">
            חילוץ באמצעות: <strong>{{ extraction_method }}</strong>
        </div>
    </div>
</div>

<div class="card">
    <h3 style="margin-bottom: 1rem;">בדוק ותקן את הנתונים לפני שליחה</h3>

    <form action="{{ url_for('process') }}" method="post" id="processForm">
        <input type="hidden" name="session_id" value="{{ session_id }}">

        {% for ps in payslips %}
        <div class="payslip-card {{ '' if ps.is_valid else 'invalid' }} {{ 'already-sent' if ps.already_sent }}">
            <div class="preview-thumb" onclick="openLightbox('{{ url_for('page_preview', session_id=session_id, page_number=ps.page - 1) }}')">
                <img src="{{ url_for('page_preview', session_id=session_id, page_number=ps.page - 1) }}"
                     alt="תלוש עמוד {{ ps.page }}" loading="lazy">
            </div>

            <div class="payslip-fields">
                <div class="page-header">
                    <span class="page-badge">עמוד {{ ps.page }}</span>
                    {% if ps.already_sent %}
                    <span class="badge badge-yellow">כבר נשלח בעבר</span>
                    {% endif %}
                    {% if not ps.is_valid %}
                    <span class="badge badge-red">דורש תיקון</span>
                    {% endif %}
                </div>

                <div class="field-group">
                    <label>שם עובד/ת</label>
                    <input type="text" name="name_{{ loop.index0 }}" value="{{ ps.name }}"
                           class="input-sm" placeholder="שם מלא" required>
                </div>

                <div class="field-group">
                    <label>ת.ז</label>
                    <input type="text" name="employee_id_{{ loop.index0 }}" value="{{ ps.employee_id }}"
                           class="input-sm" placeholder="מספר ת.ז" required
                           pattern="\d{5,9}" title="5-9 ספרות">
                </div>

                <div class="field-group">
                    <label>אימייל</label>
                    <input type="email" name="email_{{ loop.index0 }}" value="{{ ps.email }}"
                           class="input-sm" placeholder="email@example.com">
                </div>

                <div class="field-group" style="display: flex; flex-direction: row; gap: 0.5rem; align-items: end;">
                    <div style="flex: 1;">
                        <label>חודש</label>
                        <select name="month_{{ loop.index0 }}" class="input-sm">
                            <option value="">--</option>
                            {% for num, name in hebrew_months.items() %}
                            <option value="{{ num }}" {{ 'selected' if ps.month == num }}>{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label>שנה</label>
                        <input type="number" name="year_{{ loop.index0 }}" value="{{ ps.year }}"
                               class="input-sm" placeholder="שנה" min="1900" max="2100">
                    </div>
                </div>

                <div class="field-group full-width">
                    <label>שם קובץ (מתעדכן אוטומטית)</label>
                    <div class="filename-preview" id="fn_{{ loop.index0 }}"
                         style="font-size: 0.85rem; color: #0f3460; font-weight: 600; padding: 0.3rem 0; direction: rtl;">
                        {{ ps.filename }}.pdf
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <div class="form-actions">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">חזרה</a>
            <button type="submit" class="btn btn-success" id="processBtn">
                הצפן ושלח תלושים
            </button>
        </div>
    </form>
</div>

<!-- Lightbox for full-size preview -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
    <img id="lightboxImg" src="" alt="תצוגה מקדימה">
</div>

<script>
    // Hebrew month names for filename generation
    const HEBREW_MONTHS = {
        1: 'ינואר', 2: 'פברואר', 3: 'מרץ', 4: 'אפריל',
        5: 'מאי', 6: 'יוני', 7: 'יולי', 8: 'אוגוסט',
        9: 'ספטמבר', 10: 'אוקטובר', 11: 'נובמבר', 12: 'דצמבר'
    };

    function updateFilename(idx) {
        const name = document.querySelector(`[name="name_${idx}"]`).value.trim();
        const monthVal = document.querySelector(`[name="month_${idx}"]`).value;
        const yearVal = document.querySelector(`[name="year_${idx}"]`).value.trim();
        const fnEl = document.getElementById(`fn_${idx}`);

        let displayName = name || `employee_page_${idx + 1}`;
        let filename = displayName;

        if (monthVal && yearVal) {
            const hebrewMonth = HEBREW_MONTHS[parseInt(monthVal)] || monthVal;
            filename = `${displayName} - ${hebrewMonth} ${yearVal}`;
        } else if (yearVal) {
            filename = `${displayName} - ${yearVal}`;
        }

        fnEl.textContent = filename + '.pdf';
    }

    // Attach live update listeners to all payslip fields
    const totalPayslips = {{ payslips|length }};
    for (let i = 0; i < totalPayslips; i++) {
        ['name', 'month', 'year'].forEach(field => {
            const el = document.querySelector(`[name="${field}_${i}"]`);
            if (el) {
                el.addEventListener('input', () => updateFilename(i));
                el.addEventListener('change', () => updateFilename(i));
            }
        });
    }

    // Lightbox
    function openLightbox(src) {
        const lb = document.getElementById('lightbox');
        document.getElementById('lightboxImg').src = src;
        lb.classList.add('active');
    }
    function closeLightbox() {
        document.getElementById('lightbox').classList.remove('active');
    }
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeLightbox();
    });

    // Submit lock
    document.getElementById('processForm').addEventListener('submit', function() {
        const btn = document.getElementById('processBtn');
        btn.disabled = true;
        btn.textContent = 'מעבד ושולח...';
    });
</script>
{% endblock %}
